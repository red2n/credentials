<div class="admin-dashboard">
  <!-- Header -->
  <header class="dashboard-header">
    <div class="header-content">
      <div class="header-left">
        <h1>
          <span class="admin-icon">🛡️</span>
          Admin Dashboard
        </h1>
        <p>Manage users and system configuration</p>
      </div>
      <div class="header-right">
        <button class="btn btn-secondary" (click)="logout()">
          <span class="btn-icon">🚪</span>
          Logout
        </button>
      </div>
    </div>
  </header>

  <!-- Statistics Cards -->
  @if (stats()) {
    <section class="stats-section">
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-icon">👥</div>
          <div class="stat-content">
            <div class="stat-number">{{ stats()?.totalUsers | number }}</div>
            <div class="stat-label">Total Users</div>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-icon">🚀</div>
          <div class="stat-content">
            <div class="stat-number">{{ stats()?.activeUsersWeek | number }}</div>
            <div class="stat-label">Active This Week</div>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-icon">📈</div>
          <div class="stat-content">
            <div class="stat-number">{{ stats()?.recentUsers24h | number }}</div>
            <div class="stat-label">New Today</div>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-icon">💾</div>
          <div class="stat-content">
            <div class="stat-number">{{ (stats()?.memoryUsage || 0) / 1024 / 1024 | number:'1.1-1' }}MB</div>
            <div class="stat-label">Memory Usage</div>
          </div>
        </div>
      </div>
    </section>
  }

  <!-- Messages -->
  @if (errorMessage()) {
    <div class="message-banner error" (click)="dismissMessage()">
      <div class="message-icon">⚠️</div>
      <div class="message-text">{{ errorMessage() }}</div>
      <button class="message-close">✕</button>
    </div>
  }

  @if (successMessage()) {
    <div class="message-banner success" (click)="dismissMessage()">
      <div class="message-icon">✅</div>
      <div class="message-text">{{ successMessage() }}</div>
      <button class="message-close">✕</button>
    </div>
  }

  <!-- User Management Section -->
  <section class="users-section">
    <div class="section-header">
      <h2>User Management</h2>

      <!-- Search and Actions -->
      <div class="section-controls">
        <div class="search-container">
          <div class="search-input-wrapper">
            <input
              type="text"
              [value]="searchTerm()"
              (input)="searchTerm.set($event.target.value)"
              (keyup.enter)="onSearch()"
              placeholder="Search users by username or email..."
              class="search-input"
            />
            <button class="search-btn" (click)="onSearch()" [disabled]="isLoading()">
              <span class="search-icon">🔍</span>
            </button>
          </div>
        </div>

        @if (hasSelectedUsers()) {
          <button
            class="btn btn-danger"
            (click)="onBulkDelete()"
            [disabled]="isLoading()"
          >
            <span class="btn-icon">🗑️</span>
            Deactivate Selected ({{ selectedUsers().length }})
          </button>
        }
      </div>
    </div>

    <!-- Users Table -->
    <div class="table-container">
      @if (isLoading()) {
        <div class="loading-state">
          <div class="spinner large"></div>
          <p>Loading users...</p>
        </div>
      } @else if (users().length === 0) {
        <div class="empty-state">
          <div class="empty-icon">👤</div>
          <h3>No users found</h3>
          <p>
            @if (searchTerm()) {
              No users match your search criteria. Try a different search term.
            } @else {
              There are no users in the system yet.
            }
          </p>
        </div>
      } @else {
        <table class="users-table">
          <thead>
            <tr>
              <th class="checkbox-col">
                <label class="checkbox-label">
                  <input
                    type="checkbox"
                    [checked]="allUsersSelected()"
                    (change)="onSelectAll()"
                    class="table-checkbox"
                  />
                  <span class="checkmark"></span>
                </label>
              </th>
              <th>Username</th>
              <th>Email</th>
              <th>Created</th>
              <th>Last Login</th>
              <th>Status</th>
              <th class="actions-col">Actions</th>
            </tr>
          </thead>
          <tbody>
            @for (user of users(); track user.username) {
              <tr class="user-row">
                <td class="checkbox-col">
                  <label class="checkbox-label">
                    <input
                      type="checkbox"
                      [checked]="selectedUsers().includes(user.username)"
                      (change)="onSelectUser(user.username)"
                      class="table-checkbox"
                    />
                    <span class="checkmark"></span>
                  </label>
                </td>
                <td class="username-col">
                  <div class="user-info">
                    <div class="user-avatar">{{ user.username.charAt(0).toUpperCase() }}</div>
                    <span class="username">{{ user.username }}</span>
                  </div>
                </td>
                <td class="email-col">{{ user.email || '—' }}</td>
                <td class="date-col">{{ formatDate(user.createdAt) }}</td>
                <td class="date-col">
                  @if (user.lastLogin) {
                    {{ formatDate(user.lastLogin) }}
                  } @else {
                    <span class="never-logged-in">Never</span>
                  }
                </td>
                <td class="status-col">
                  <span class="status-badge active">Active</span>
                </td>
                <td class="actions-col">
                  <button
                    class="btn btn-sm btn-danger"
                    (click)="onDeleteUser(user.username)"
                    [disabled]="isLoading()"
                    title="Deactivate user"
                  >
                    <span class="btn-icon">🗑️</span>
                  </button>
                </td>
              </tr>
            }
          </tbody>
        </table>
      }
    </div>

    <!-- Pagination -->
    @if (totalPages() > 1 && !isLoading()) {
      <div class="pagination-container">
        <div class="pagination">
          <button
            class="pagination-btn"
            [disabled]="currentPage() === 1"
            (click)="onPageChange(currentPage() - 1)"
          >
            ‹ Previous
          </button>

          @for (page of getPages(); track page) {
            <button
              class="pagination-btn"
              [class.active]="page === currentPage()"
              (click)="onPageChange(page)"
            >
              {{ page }}
            </button>
          }

          <button
            class="pagination-btn"
            [disabled]="currentPage() === totalPages()"
            (click)="onPageChange(currentPage() + 1)"
          >
            Next ›
          </button>
        </div>
      </div>
    }
  </section>

  <!-- Delete Confirmation Modal -->
  @if (showDeleteModal()) {
    <div class="modal-overlay" (click)="closeModal()">
      <div class="modal" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3>Confirm User Deactivation</h3>
          <button class="modal-close" (click)="closeModal()">✕</button>
        </div>
        <div class="modal-body">
          <p>Are you sure you want to deactivate the user <strong>{{ userToDelete() }}</strong>?</p>
          <p class="warning-text">This action cannot be undone. The user will be permanently removed from the system.</p>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" (click)="closeModal()">Cancel</button>
          <button
            class="btn btn-danger"
            (click)="confirmDeleteUser()"
            [disabled]="isLoading()"
          >
            @if (isLoading()) {
              <div class="spinner small"></div>
              Deactivating...
            } @else {
              Deactivate User
            }
          </button>
        </div>
      </div>
    </div>
  }

  <!-- Bulk Delete Confirmation Modal -->
  @if (showBulkDeleteModal()) {
    <div class="modal-overlay" (click)="closeModal()">
      <div class="modal" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3>Confirm Bulk Deactivation</h3>
          <button class="modal-close" (click)="closeModal()">✕</button>
        </div>
        <div class="modal-body">
          <p>Are you sure you want to deactivate <strong>{{ selectedUsers().length }}</strong> selected users?</p>
          <p class="warning-text">This action cannot be undone. All selected users will be permanently removed from the system.</p>
          <div class="selected-users">
            <h4>Selected users:</h4>
            <ul>
              @for (username of selectedUsers(); track username) {
                <li>{{ username }}</li>
              }
            </ul>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" (click)="closeModal()">Cancel</button>
          <button
            class="btn btn-danger"
            (click)="confirmBulkDelete()"
            [disabled]="isLoading()"
          >
            @if (isLoading()) {
              <div class="spinner small"></div>
              Deactivating...
            } @else {
              Deactivate {{ selectedUsers().length }} Users
            }
          </button>
        </div>
      </div>
    </div>
  }
</div>
